#!/usr/bin/env node

/**
 * ASSISTENTE MANUAL QUEENBOOKS - ESTRUTURA REAL
 * 
 * Baseado na descoberta da estrutura real:
 * - Busca: https://www.queenbooks.com.br/?busca=[C√ìDIGO]
 * - Produto: https://www.queenbooks.com.br/produtos/[ID]
 */

const fs = require('fs-extra');
const path = require('path');

class QueenBooksAssistenteManual {
  constructor() {
    this.dataDir = './data/assistente-manual';
    this.productsFile = './data/products/manual_products.json';
  }

  async init() {
    await fs.ensureDir(this.dataDir);
    await fs.ensureDir('./data/products');
  }

  async criarAssistenteProduto(codigo) {
    console.log('üéØ ASSISTENTE MANUAL QUEENBOOKS');
    console.log('=' .repeat(60));
    console.log(`üìã C√≥digo do produto: ${codigo}`);
    console.log('');

    const urlBusca = `https://www.queenbooks.com.br/?busca=${codigo}`;
    
    console.log('üìç PASSO A PASSO DETALHADO:');
    console.log('=' .repeat(40));
    
    console.log('\n1Ô∏è‚É£ ACESSE A P√ÅGINA DE BUSCA:');
    console.log(`üîó ${urlBusca}`);
    console.log('');

    console.log('2Ô∏è‚É£ PROCURE O PRODUTO:');
    console.log('   ‚Ä¢ Produto deve aparecer nos resultados');
    console.log('   ‚Ä¢ Procure pelo c√≥digo ou t√≠tulo similar');
    console.log('   ‚Ä¢ Se n√£o aparecer, produto pode n√£o existir');
    console.log('');

    console.log('3Ô∏è‚É£ CLIQUE NO PRODUTO:');
    console.log('   ‚Ä¢ Clique na imagem ou t√≠tulo do produto');
    console.log('   ‚Ä¢ Voc√™ ser√° redirecionado para URL como:');
    console.log('   ‚Ä¢ https://www.queenbooks.com.br/produtos/[N√öMERO_ID]');
    console.log('   ‚Ä¢ Exemplo: https://www.queenbooks.com.br/produtos/211042616');
    console.log('');

    console.log('4Ô∏è‚É£ COLETE OS DADOS NA P√ÅGINA DO PRODUTO:');
    console.log('');

    // Criar template estruturado
    const template = await this.criarTemplateEstruturado(codigo, urlBusca);
    
    console.log('üìÑ TEMPLATE CRIADO PARA PREENCHIMENTO:');
    console.log(`üìÅ ${template.arquivo}`);
    console.log('');

    console.log('5Ô∏è‚É£ PREENCHA O TEMPLATE:');
    console.log('   ‚Ä¢ Abra o arquivo JSON criado');
    console.log('   ‚Ä¢ Substitua os valores [PREENCHER] pelos dados reais');
    console.log('   ‚Ä¢ Salve o arquivo');
    console.log('');

    console.log('6Ô∏è‚É£ PROCESSE O PRODUTO:');
    console.log(`   node assistente-manual.js processar ${template.arquivo}`);
    console.log('');

    this.exibirInstrucoesCampos();

    return template;
  }

  async criarTemplateEstruturado(codigo, urlBusca) {
    const template = {
      // Informa√ß√µes b√°sicas
      codigo: codigo,
      urlBusca: urlBusca,
      urlProduto: '[PREENCHER] - https://www.queenbooks.com.br/produtos/[ID]',
      idProduto: '[PREENCHER] - N√∫mero do ID (ex: 211042616)',
      
      // Dados principais
      titulo: '[PREENCHER] - T√≠tulo completo do livro',
      preco: '[PREENCHER] - Ex: R$ 1.280,00 ou null se n√£o vis√≠vel',
      status: '[PREENCHER] - available ou unavailable',
      
      // Descri√ß√£o
      descricao: '[PREENCHER] - Descri√ß√£o completa do produto',
      
      // Imagens (array)
      fotos: [
        '[PREENCHER] - URL da foto 1',
        '[PREENCHER] - URL da foto 2',
        '[PREENCHER] - URL da foto 3'
        // Adicione mais se necess√°rio
      ],
      
      // Informa√ß√µes do produto
      informacoes: {
        autor: '[PREENCHER] - Nome do autor',
        editora: '[PREENCHER] - Nome da editora', 
        isbn: '[PREENCHER] - C√≥digo ISBN',
        paginas: '[PREENCHER] - N√∫mero de p√°ginas',
        ano: '[PREENCHER] - Ano de publica√ß√£o',
        idioma: '[PREENCHER] - Idioma do livro',
        dimensoes: '[PREENCHER] - Dimens√µes f√≠sicas',
        peso: '[PREENCHER] - Peso do livro'
      },
      
      // Para dropshipping
      categoria: '[PREENCHER] - Categoria do produto',
      tags: [
        '[PREENCHER] - tag1',
        '[PREENCHER] - tag2', 
        '[PREENCHER] - tag3'
      ],
      
      // An√°lise para venda
      dropshipping: {
        adequado: '[PREENCHER] - true ou false',
        margem_sugerida: '[PREENCHER] - Ex: 20-30%',
        publico_alvo: '[PREENCHER] - Descri√ß√£o do p√∫blico',
        concorrencia: '[PREENCHER] - Alta, Media, Baixa',
        observacoes: '[PREENCHER] - Observa√ß√µes para venda'
      },
      
      // Metadados
      coletadoEm: new Date().toISOString(),
      metodo: 'assistente_manual_estruturado',
      preenchido: false
    };

    // Salvar template
    const nomeArquivo = `template_${codigo}_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
    const caminhoArquivo = path.join(this.dataDir, nomeArquivo);
    
    await fs.writeJSON(caminhoArquivo, template, { spaces: 2 });
    
    return {
      template: template,
      arquivo: caminhoArquivo,
      nomeArquivo: nomeArquivo
    };
  }

  exibirInstrucoesCampos() {
    console.log('üìù INSTRU√á√ïES DETALHADAS POR CAMPO:');
    console.log('=' .repeat(50));
    
    console.log('\nüîó URL_PRODUTO:');
    console.log('   ‚Ä¢ Copie a URL completa da p√°gina do produto');
    console.log('   ‚Ä¢ Ex: https://www.queenbooks.com.br/produtos/211042616');
    
    console.log('\nüÜî ID_PRODUTO:');
    console.log('   ‚Ä¢ Copie apenas o n√∫mero da URL');
    console.log('   ‚Ä¢ Ex: 211042616');
    
    console.log('\nüìö T√çTULO:');
    console.log('   ‚Ä¢ Copie o t√≠tulo completo exibido na p√°gina');
    console.log('   ‚Ä¢ Mantenha acentos e formata√ß√£o original');
    
    console.log('\nüí∞ PRE√áO:');
    console.log('   ‚Ä¢ Se vis√≠vel: "R$ 1.280,00"');
    console.log('   ‚Ä¢ Se n√£o vis√≠vel: null');
    
    console.log('\nüìä STATUS:');
    console.log('   ‚Ä¢ "available" - se tem bot√£o COMPRAR/ADICIONAR');
    console.log('   ‚Ä¢ "unavailable" - se mostra ESGOTADO/INDISPON√çVEL');
    
    console.log('\nüñºÔ∏è  FOTOS:');
    console.log('   ‚Ä¢ Clique direito na imagem > Copiar endere√ßo da imagem');
    console.log('   ‚Ä¢ Adicione m√∫ltiplas URLs se houver v√°rias fotos');
    console.log('   ‚Ä¢ Remova entradas [PREENCHER] n√£o utilizadas');
    
    console.log('\nüìã INFORMA√á√ïES:');
    console.log('   ‚Ä¢ Procure se√ß√£o "Informa√ß√µes do Produto"');
    console.log('   ‚Ä¢ Ou tabela com especifica√ß√µes t√©cnicas');
    console.log('   ‚Ä¢ Preencha apenas campos dispon√≠veis');
    
    console.log('\nüéØ DROPSHIPPING:');
    console.log('   ‚Ä¢ adequado: true (se vale a pena vender)');
    console.log('   ‚Ä¢ margem_sugerida: "15-25%" (sua margem de lucro)');
    console.log('   ‚Ä¢ publico_alvo: quem compraria este produto');
  }

  async processarTemplatePreenchido(caminhoArquivo) {
    try {
      console.log('üîÑ PROCESSANDO TEMPLATE PREENCHIDO');
      console.log('=' .repeat(50));
      
      const produto = await fs.readJSON(caminhoArquivo);
      
      // Validar se foi preenchido
      const validacao = this.validarPreenchimento(produto);
      
      if (!validacao.valido) {
        console.log('‚ùå TEMPLATE N√ÉO PREENCHIDO COMPLETAMENTE:');
        validacao.erros.forEach(erro => {
          console.log(`   ‚Ä¢ ${erro}`);
        });
        console.log('');
        console.log('üìù Edite o arquivo e preencha os campos obrigat√≥rios');
        return null;
      }

      // Processar e adicionar ao sistema
      const produtoFormatado = this.formatarParaSistema(produto);
      
      // Adicionar ao sistema de dropshipping
      await this.addProduct(produtoFormatado);
      
      // Salvar vers√£o processada
      const arquivoProcessado = caminhoArquivo.replace('template_', 'processado_');
      produto.preenchido = true;
      produto.processadoEm = new Date().toISOString();
      await fs.writeJSON(arquivoProcessado, produto, { spaces: 2 });
      
      console.log('‚úÖ PRODUTO PROCESSADO COM SUCESSO!');
      console.log('=' .repeat(50));
      console.log(`üìö T√≠tulo: ${produto.titulo}`);
      console.log(`üî¢ C√≥digo: ${produto.codigo}`);
      console.log(`üí∞ Pre√ßo: ${produto.preco}`);
      console.log(`üìä Status: ${produto.status}`);
      console.log(`üñºÔ∏è  Fotos: ${produto.fotos.filter(f => !f.includes('[PREENCHER]')).length}`);
      console.log(`üîó URL: ${produto.urlProduto}`);
      console.log('');
      console.log('üéâ Produto adicionado ao sistema de dropshipping!');
      
      return produto;
      
    } catch (error) {
      console.error(`‚ùå Erro ao processar template: ${error.message}`);
      return null;
    }
  }

  validarPreenchimento(produto) {
    const erros = [];
    const camposObrigatorios = [
      'titulo', 'urlProduto', 'idProduto', 'status'
    ];
    
    camposObrigatorios.forEach(campo => {
      if (!produto[campo] || produto[campo].toString().includes('[PREENCHER]')) {
        erros.push(`Campo obrigat√≥rio n√£o preenchido: ${campo}`);
      }
    });
    
    // Validar pelo menos uma foto
    const fotosValidas = produto.fotos.filter(foto => !foto.includes('[PREENCHER]'));
    if (fotosValidas.length === 0) {
      erros.push('Pelo menos uma foto deve ser preenchida');
    }
    
    return {
      valido: erros.length === 0,
      erros: erros
    };
  }

  formatarParaSistema(produto) {
    return {
      codigo: produto.codigo,
      title: produto.titulo,
      category: produto.categoria.replace('[PREENCHER] - ', '') || 'Manual',
      availability: produto.status,
      price: produto.preco === 'null' ? null : produto.preco,
      imageUrl: produto.fotos.find(foto => !foto.includes('[PREENCHER]')) || null,
      productLink: produto.urlProduto,
      notes: produto.descricao.replace('[PREENCHER] - ', '') || 'Produto coletado manualmente',
      informacoes: produto.informacoes,
      dropshipping: produto.dropshipping
    };
  }

  async listarTemplates() {
    try {
      const arquivos = await fs.readdir(this.dataDir);
      const templates = arquivos.filter(arquivo => arquivo.startsWith('template_'));
      
      if (templates.length === 0) {
        console.log('üìÑ Nenhum template encontrado');
        return;
      }
      
      console.log('üìÑ TEMPLATES DISPON√çVEIS:');
      console.log('=' .repeat(40));
      
      for (const template of templates) {
        const produto = await fs.readJSON(path.join(this.dataDir, template));
        const status = produto.preenchido ? '‚úÖ Preenchido' : '‚è≥ Pendente';
        console.log(`${status} ${produto.codigo} - ${template}`);
      }
      
    } catch (error) {
      console.error('Erro ao listar templates:', error.message);
    }
  }

  // M√©todo para adicionar produtos ao sistema
  async addProduct(produto) {
    try {
      // Carregar produtos existentes
      let produtos = {};
      if (await fs.pathExists(this.productsFile)) {
        produtos = await fs.readJSON(this.productsFile);
      }

      // Adicionar novo produto
      const productId = produto.code || `product_${Date.now()}`;
      produtos[productId] = {
        ...produto,
        addedAt: new Date().toISOString()
      };

      // Salvar produtos atualizados
      await fs.writeJSON(this.productsFile, produtos, { spaces: 2 });
      
      console.log(`‚úÖ Produto adicionado ao sistema: ${produto.title}`);
      return produto;
    } catch (error) {
      console.error('‚ùå Erro ao adicionar produto:', error.message);
      throw error;
    }
    }
  }
}

async function main() {
  const comando = process.argv[2];
  const parametro = process.argv[3];

  const assistente = new QueenBooksAssistenteManual();
  await assistente.init();

  switch (comando) {
    case 'processar':
      if (!parametro) {
        console.log('‚ùå Caminho do arquivo √© obrigat√≥rio');
        console.log('Uso: node assistente-manual.js processar [ARQUIVO.json]');
        return;
      }
      await assistente.processarTemplatePreenchido(parametro);
      break;

    case 'listar':
      await assistente.listarTemplates();
      break;

    default:
      if (comando && comando.length > 5) {
        // Criar assistente para c√≥digo
        await assistente.criarAssistenteProduto(comando);
      } else {
        console.log('‚ùå Uso incorreto');
        console.log('');
        console.log('CRIAR ASSISTENTE:');
        console.log('  node assistente-manual.js [C√ìDIGO_ISBN]');
        console.log('  Exemplo: node assistente-manual.js 9786587141411');
        console.log('');
        console.log('PROCESSAR TEMPLATE:');
        console.log('  node assistente-manual.js processar [ARQUIVO.json]');
        console.log('');
        console.log('LISTAR TEMPLATES:');
        console.log('  node assistente-manual.js listar');
        console.log('');
      }
      break;
  }

  // M√©todo para adicionar produtos ao sistema
  async addProduct(produto) {
    try {
      // Carregar produtos existentes
      let produtos = {};
      if (await fs.pathExists(this.productsFile)) {
        produtos = await fs.readJSON(this.productsFile);
      }

      // Adicionar novo produto
      const productId = produto.code || `product_${Date.now()}`;
      produtos[productId] = {
        ...produto,
        addedAt: new Date().toISOString()
      };

      // Salvar produtos atualizados
      await fs.writeJSON(this.productsFile, produtos, { spaces: 2 });
      
      console.log(`‚úÖ Produto adicionado ao sistema: ${produto.title}`);
      return produto;
    } catch (error) {
      console.error('‚ùå Erro ao adicionar produto:', error.message);
      throw error;
    }
  }
}

if (require.main === module) {
  main().catch(console.error);
}

module.exports = { QueenBooksAssistenteManual };
